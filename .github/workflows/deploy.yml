name: Deploy to VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e 

            # 1. Add GitHub to known_hosts to prevent "Host key verification failed"
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null || true

            # 2. Check if repo exists
            if [ -d "~/new-website/.git" ]; then
              echo "Repository exists. Pulling latest changes..."
              cd ~/new-website
              git pull origin main
            else
              echo "Repository not found. Cloning..."
              # CLEANUP: If directory exists but isn't a git repo, remove it to prevent "directory not empty" error
              if [ -d "$HOME/new-website" ]; then
                  echo "Removing existing non-git directory..."
                  rm -rf "$HOME/new-website"
              fi
              
              # Clone
              git clone git@github.com:RAJAT-KHANDELWAL-PROFILE/KOEI-MEDIA.git ~/new-website
            fi
